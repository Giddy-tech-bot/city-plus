<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CityPlus - Your Urban Connection</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css">
    <link rel="stylesheet" href="style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>
<body>
    <div class="app-container">
        <!-- App Header -->
        <div class="app-header">
            <div class="logo">C+</div>
            <h1 class="app-title">Cityplus</h1>
            <p class="app-subtitle">CITY SHUTTLE - Your Urban Connection</p>
        </div>
        
        <!-- Login Panel -->
        <div id="login-panel" class="login-container">
            <div class="login-form">
                <div class="login-option" id="google-login">
                    <div class="login-icon google">
                        <i class="fab fa-google"></i>
                    </div>
                    <div class="login-text">
                        <h3>Continue with Google</h3>
                        <p>Sign in with your Google account</p>
                    </div>
                </div>
                
                <div class="login-option" id="facebook-login">
                    <div class="login-icon facebook">
                        <i class="fab fa-facebook-f"></i>
                    </div>
                    <div class="login-text">
                        <h3>Continue with Facebook</h3>
                        <p>Sign in with your Facebook account</p>
                    </div>
                </div>
                
                <div class="divider">
                    <span>Or sign in with</span>
                </div>
                
                <div class="login-option" id="email-login">
                    <div class="login-icon email">
                        <i class="fas fa-envelope"></i>
                    </div>
                    <div class="login-text">
                        <h3>Sign in with Email</h3>
                        <p>Use your email address</p>
                    </div>
                </div>
                
                <div class="login-option" id="phone-login">
                    <div class="login-icon phone">
                        <i class="fas fa-phone-alt"></i>
                    </div>
                    <div class="login-text">
                        <h3>Sign in with Phone</h3>
                        <p>Use your mobile number</p>
                    </div>
                </div>
                
                <!-- Email Login Form -->
                <div id="email-form" style="display: none;">
                    <div class="input-group">
                        <label class="input-label">Email Address</label>
                        <input type="email" class="input-field" id="email-input" placeholder="Enter your email">
                    </div>
                    
                    <div class="input-group">
                        <label class="input-label">Password</label>
                        <div class="password-container">
                            <input type="password" class="input-field" id="password-input" placeholder="Enter your password">
                            <button class="password-toggle" id="toggle-password">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                        <a href="#" class="forgot-link">Forgot Password?</a>
                    </div>
                    
                    <button class="login-btn" id="email-submit">Sign In</button>
                    <button class="login-btn" id="back-to-options" style="background: linear-gradient(to right, #6c757d, #495057); margin-top: 10px;">
                        <i class="fas fa-arrow-left"></i> Back to Options
                    </button>
                </div>
                
                <!-- Phone Login Form -->
                <div id="phone-form" style="display: none;">
                    <div class="input-group">
                        <label class="input-label">Phone Number</label>
                        <input type="tel" class="input-field" id="phone-input" placeholder="Enter your phone number">
                    </div>
                    
                    <div class="input-group">
                        <label class="input-label">Password</label>
                        <div class="password-container">
                            <input type="password" class="input-field" id="phone-password" placeholder="Enter your password">
                            <button class="password-toggle" id="toggle-phone-password">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                        <a href="#" class="forgot-link">Forgot Password?</a>
                    </div>
                    
                    <button class="login-btn" id="phone-submit">Sign In</button>
                    <button class="login-btn" id="back-to-options-phone" style="background: linear-gradient(to right, #6c757d, #495057); margin-top: 10px;">
                        <i class="fas fa-arrow-left"></i> Back to Options
                    </button>
                </div>
                
                <div class="signup-link">
                    Don't have an account? <a href="#" id="signup-link">Sign up</a>
                </div>
            </div>
        </div>
        
        <!-- Main App Content -->
        <div id="main-app" class="main-content" style="display: none;">
            <!-- Top Bar -->
            <div class="top-bar">
                <div class="app-info">
                    <h1>Cityplus</h1>
                    <p>Your Urban Connection</p>
                </div>
                <div class="top-icons">
                    <div class="top-icon" onclick="showNotifications()">
                        <i class="fas fa-bell"></i>
                        <span class="notification-badge">2</span>
                    </div>
                </div>
            </div>
            
            <!-- Top Navigation -->
            <div class="top-nav">
                <button class="top-nav-btn active" onclick="showSection('home-content')">Home</button>
                <button class="top-nav-btn" onclick="showSection('routes-content')">Routes</button>
                <button class="top-nav-btn" onclick="showSection('payment-content')">Payment</button>
                <button class="top-nav-btn" onclick="showSection('kyc-content')">KYC</button>
            </div>
            
            <!-- Home Content -->
            <div id="home-content" class="content-section active">
                <div class="welcome-section">
                    <div class="welcome-text">Welcome back,</div>
                    <div class="user-name">John Doe</div>
                </div>
                
                <div class="subscription-card">
                    <div class="plan-name">
                        Monthly Pass
                        <span><i class="fas fa-crown"></i></span>
                    </div>
                    <div class="plan-price">Ksh 4,000</div>
                    <div class="plan-details">
                        Unlimited shuttle rides for 30 days. Generate a daily QR code valid for up to 2 trips per day. Access to premium shuttles and priority boarding.
                    </div>
                    <button class="action-btn" onclick="renewSubscription()">
                        <i class="fas fa-sync-alt"></i> Renew Subscription
                    </button>
                </div>
                
                <div class="qr-container">
                    <div id="qr-code" class="qr-display"></div>
                    <p style="font-size: 16px; color: #2C3E50; margin-bottom: 5px;">
                        Your Boarding Pass
                    </p>
                    <p style="font-size: 14px; color: #64748b;">
                        Present QR code to the driver
                    </p>
                    <div style="margin-top: 15px; padding: 10px; background: #f0f4f8; border-radius: 8px; text-align: center;">
                        <p style="font-size: 13px; color: #2C3E50; margin: 5px 0;">
                            <i class="fas fa-clock"></i> Expires in: <span id="qr-countdown" style="font-weight: bold; color: #FF9800;">2:00:00</span>
                        </p>
                        <button id="refresh-qr" style="margin-top: 10px; padding: 8px 16px; background: linear-gradient(to right, #3b82f6, #2563eb); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px;">
                            <i class="fas fa-sync-alt"></i> Refresh QR Code
                        </button>
                    </div>
                </div>
                
                <div class="trip-stats">
                    <div class="stat-item">
                        <div class="stat-number">2</div>
                        <div class="stat-label">Daily Trips</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number">1</div>
                        <div class="stat-label">Used Today</div>
                    </div>
                </div>
                
                <div class="valid-info">
                    <div class="valid-text">Valid until</div>
                    <div class="valid-time" id="valid-time">11:59 PM</div>
                </div>
            </div>
            
            <!-- Payment Content -->
            <div id="payment-content" class="content-section">
                <div class="welcome-section">
                    <div class="welcome-text">Payment</div>
                    <div class="user-name">Options</div>
                </div>
                
                <div class="profile-card">
                    <div class="info-row">
                        <span class="info-label">Current Balance</span>
                        <span class="info-value">Ksh 1,250</span>
                    </div>
                    
                    <div class="info-row">
                        <span class="info-label">Subscription Plan</span>
                        <span class="info-value">Monthly Pass</span>
                    </div>
                    
                    <div class="info-row">
                        <span class="info-label">Next Payment</span>
                        <span class="info-value">15/12/2023</span>
                    </div>
                    
                    <div class="info-row">
                        <span class="info-label">Monthly Fee</span>
                        <span class="info-value">Ksh 4,000</span>
                    </div>
                </div>
                
                <div class="payment-options">
                    <div class="payment-option active" onclick="selectPayment('mpesa')">
                        <div class="payment-icon">
                            <i class="fas fa-mobile-alt"></i>
                        </div>
                        <div class="payment-info">
                            <h3>M-Pesa</h3>
                            <p>Mobile Money Payment</p>
                        </div>
                    </div>
                    
                    <div class="payment-option" onclick="selectPayment('card')">
                        <div class="payment-icon">
                            <i class="far fa-credit-card"></i>
                        </div>
                        <div class="payment-info">
                            <h3>Credit/Debit Card</h3>
                            <p>Visa, Mastercard, Amex</p>
                        </div>
                    </div>
                    
                    <div class="payment-option" onclick="selectPayment('bank')">
                        <div class="payment-icon">
                            <i class="fas fa-university"></i>
                        </div>
                        <div class="payment-info">
                            <h3>Bank Transfer</h3>
                            <p>Direct bank transfer</p>
                        </div>
                    </div>
                </div>
                
                <button class="action-btn" onclick="makePayment()">
                    <i class="fas fa-lock"></i> Make Payment
                </button>
            </div>
               
            <!-- KYC Content -->
            <div id="kyc-content" class="content-section">
                <div class="welcome-section">
                    <div class="welcome-text">KYC</div>
                    <div class="user-name">Verification</div>
                </div>
                
                <div class="kyc-status">
                    <div class="kyc-text">
                        <h3>KYC Verification</h3>
                        <p>Complete verification to access all features</p>
                    </div>
                    <div class="kyc-badge">Pending</div>
                </div>
                
                <div class="upload-card">
                    <div class="upload-icon">
                        <i class="fas fa-id-card"></i>
                    </div>
                    <div class="upload-title">Upload ID Document</div>
                    <div class="upload-desc">Upload front and back of your government ID</div>
                    <button class="upload-btn" onclick="uploadID()">Upload ID</button>
                </div>
                
                <div class="upload-card">
                    <div class="upload-icon">
                        <i class="fas fa-camera"></i>
                    </div>
                    <div class="upload-title">Take Selfie</div>
                    <div class="upload-desc">Take a clear photo of yourself</div>
                    <button class="upload-btn" onclick="takeSelfie()">Take Photo</button>
                </div>
                
                <button class="action-btn" onclick="submitKYC()">
                    <i class="fas fa-paper-plane"></i> Submit for Verification
                </button>
                
                <p style="text-align: center; color: #4CAF50; font-size: 13px; margin-top: 15px;">
                    <i class="fas fa-clock"></i> Verification usually takes 1-3 business days
                </p>
            </div>

            <!-- Routes Content -->
            <div id="routes-content" class="content-section">
                <div class="welcome-section">
                    <div class="welcome-text">City Shuttle</div>
                    <div class="user-name">Routes</div>
                </div>
                
                <div class="routes-container">
                    <div class="routes-info">
                        <p>Select a location to view the shuttle route on the map</p>
                    </div>
                    
                    <div class="locations-grid">
                        <button class="location-btn" onclick="showLocationRoute('tao')">
                            <i class="fas fa-map-pin"></i>
                            <span>Tao</span>
                        </button>
                        <button class="location-btn" onclick="showLocationRoute('afya')">
                            <i class="fas fa-map-pin"></i>
                            <span>Afya Center</span>
                        </button>
                        <button class="location-btn" onclick="showLocationRoute('uhuru')">
                            <i class="fas fa-map-pin"></i>
                            <span>Uhuru Park</span>
                        </button>
                        <button class="location-btn" onclick="showLocationRoute('moi')">
                            <i class="fas fa-map-pin"></i>
                            <span>Moi Avenue</span>
                        </button>
                        <button class="location-btn" onclick="showLocationRoute('nyayo')">
                            <i class="fas fa-map-pin"></i>
                            <span>Nyayo</span>
                        </button>
                        <button class="location-btn" onclick="showLocationRoute('harambee')">
                            <i class="fas fa-map-pin"></i>
                            <span>Harambee</span>
                        </button>
                    </div>
                    
                    <div id="route-map-container" class="route-map-container" style="display: none;">
                        <div id="route-map" class="route-map"></div>
                        <div class="route-details">
                            <h3 id="route-name"></h3>
                            <p id="route-description"></p>
                            <div class="route-info-box">
                                <p><strong>Distance:</strong> <span id="route-distance"></span></p>
                                <p><strong>Estimated Time:</strong> <span id="route-time"></span></p>
                                <p><strong>Coordinates:</strong> <span id="route-coords"></span></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Buses Content - BLE Tracker -->
            <div id="buses-content" class="content-section">
                <div class="welcome-section">
                    <div class="welcome-text">Find Incoming</div>
                    <div class="user-name">City Shuttle Buses</div>
                </div>

                <div class="buses-container">
                    <!-- BLE Scanner Section -->
                    <div class="ble-scanner-section">
                        <div class="scanner-header">
                            <h3><i class="fas fa-bluetooth"></i> Bluetooth Bus Tracker</h3>
                            <p>Scan for nearby buses using BLE tracking</p>
                        </div>

                        <div class="scanner-controls">
                            <button class="scan-btn" id="ble-scan-btn" onclick="startBLEScan()">
                                <i class="fas fa-search"></i> Start Scanning for Buses
                            </button>
                            <button class="scan-btn stop-btn" id="ble-stop-btn" onclick="stopBLEScan()" style="display:none;">
                                <i class="fas fa-stop-circle"></i> Stop Scanning
                            </button>
                        </div>

                        <div class="scanner-status" id="scanner-status" style="display:none;">
                            <div class="status-icon scanning">
                                <i class="fas fa-spinner fa-spin"></i>
                            </div>
                            <div class="status-text">
                                <p id="status-message">Scanning for nearby buses...</p>
                                <p id="device-count">Devices found: 0</p>
                            </div>
                        </div>

                        <div class="browser-warning" id="browser-warning" style="display:none;">
                            <i class="fas fa-exclamation-triangle"></i>
                            <p>Web Bluetooth is not supported on this device/browser. Please use Chrome, Edge, or Opera on Android/Windows.</p>
                        </div>
                    </div>

                    <!-- Buses List -->
                    <div class="buses-list" id="buses-list">
                        <p class="no-buses-message">No buses detected yet. Tap "Start Scanning" to find nearby buses.</p>
                    </div>

                    <!-- Demo/Fallback Buses -->
                    <div class="buses-demo-section" id="buses-demo-section" style="margin-top: 25px;">
                        <h3 style="color: #2C3E50; margin-bottom: 15px;">
                            <i class="fas fa-info-circle" style="margin-right: 8px;"></i>Available Routes
                        </h3>
                        <div class="buses-list" id="demo-buses">
                            <!-- Demo buses will be generated here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Profile Content -->
            <div id="profile-content" class="content-section">
                <!-- Profile View (After KYC) -->
                <div id="profile-view" class="profile-view" style="display:none;">
                    <div class="profile-header">
                        <div class="profile-avatar">
                            <i class="fas fa-user-circle"></i>
                        </div>
                        <div class="profile-status">
                            <h2 id="profile-username">John Doe</h2>
                            <p id="profile-verification-status" class="verification-badge verified">
                                <i class="fas fa-check-circle"></i> Verified
                            </p>
                        </div>
                    </div>

                    <div class="profile-details-card">
                        <div class="detail-section">
                            <h3>Personal Information</h3>
                            <div class="detail-item">
                                <span class="detail-label">Full Name</span>
                                <span class="detail-value" id="verified-fullname">-</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Email</span>
                                <span class="detail-value" id="verified-email">-</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Phone Number</span>
                                <span class="detail-value" id="verified-phone">-</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Date of Birth</span>
                                <span class="detail-value" id="verified-dob">-</span>
                            </div>
                        </div>

                        <div class="detail-section">
                            <h3>Identification Documents</h3>
                            <div class="detail-item">
                                <span class="detail-label">ID Type</span>
                                <span class="detail-value" id="verified-idtype">-</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">ID Number</span>
                                <span class="detail-value" id="verified-idnumber">-</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">ID Document</span>
                                <div class="verified-document">
                                    <i class="fas fa-file-pdf"></i>
                                    <span id="verified-iddoc-name">document.pdf</span>
                                </div>
                            </div>
                        </div>

                        <div class="detail-section">
                            <h3>Verification Documents</h3>
                            <div class="detail-item">
                                <span class="detail-label">Passport Photo</span>
                                <div class="verified-photo">
                                    <img id="verified-passport" src="" alt="Passport Photo" style="width: 100%; border-radius: 8px;">
                                </div>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Selfie Verification</span>
                                <div class="verified-photo">
                                    <img id="verified-selfie" src="" alt="Selfie" style="width: 100%; border-radius: 8px;">
                                </div>
                            </div>
                        </div>

                        <div class="detail-section">
                            <h3>Payment Information</h3>
                            <div class="detail-item">
                                <span class="detail-label">Credit Card (Last 4 digits)</span>
                                <span class="detail-value" id="verified-cardlast4">•••• •••• •••• ****</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Card Holder Name</span>
                                <span class="detail-value" id="verified-cardholder">-</span>
                            </div>
                        </div>

                        <div class="detail-section">
                            <h3>Additional Information</h3>
                            <div class="detail-item">
                                <span class="detail-label">Address</span>
                                <span class="detail-value" id="verified-address">-</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Verification Date</span>
                                <span class="detail-value" id="verified-date">-</span>
                            </div>
                        </div>
                    </div>

                    <div class="profile-actions">
                        <button class="action-btn" onclick="editProfile()">
                            <i class="fas fa-edit"></i> Edit Profile
                        </button>
                        <button class="action-btn secondary" onclick="showKYCForm()">
                            <i class="fas fa-refresh"></i> Update KYC
                        </button>
                    </div>
                </div>

                <!-- KYC Verification Form (Before Verification) -->
                <div id="kyc-form-view" class="kyc-form-view">
                    <div class="welcome-section">
                        <div class="welcome-text">Complete Your</div>
                        <div class="user-name">KYC Verification</div>
                    </div>

                    <div class="kyc-progress">
                        <div class="progress-step completed">
                            <div class="step-number">1</div>
                            <div class="step-label">Personal Info</div>
                        </div>
                        <div class="progress-line"></div>
                        <div class="progress-step">
                            <div class="step-number">2</div>
                            <div class="step-label">Documents</div>
                        </div>
                        <div class="progress-line"></div>
                        <div class="progress-step">
                            <div class="step-number">3</div>
                            <div class="step-label">Verification</div>
                        </div>
                    </div>

                    <!-- Personal Information Form -->
                    <div class="kyc-section">
                        <h3>Personal Information</h3>
                        <div class="form-group">
                            <label class="input-label">Full Name</label>
                            <input type="text" class="input-field" id="kyc-fullname" placeholder="Enter your full name">
                        </div>
                        <div class="form-group">
                            <label class="input-label">Email Address</label>
                            <input type="email" class="input-field" id="kyc-email" placeholder="Enter your email">
                        </div>
                        <div class="form-group">
                            <label class="input-label">Phone Number</label>
                            <input type="tel" class="input-field" id="kyc-phone" placeholder="Enter your phone number">
                        </div>
                        <div class="form-group">
                            <label class="input-label">Date of Birth</label>
                            <input type="date" class="input-field" id="kyc-dob">
                        </div>
                    </div>

                    <!-- Identification Section -->
                    <div class="kyc-section">
                        <h3>Identification Documents</h3>
                        <div class="form-group">
                            <label class="input-label">ID Type</label>
                            <select class="input-field" id="kyc-idtype">
                                <option value="">Select ID Type</option>
                                <option value="national-id">National ID</option>
                                <option value="passport">Passport</option>
                                <option value="drivers-license">Driver's License</option>
                                <option value="voter-card">Voter's Card</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="input-label">ID Number</label>
                            <input type="text" class="input-field" id="kyc-idnumber" placeholder="Enter your ID number">
                        </div>
                        <div class="form-group">
                            <label class="input-label">Upload ID Document</label>
                            <div class="file-upload">
                                <input type="file" id="kyc-iddoc" accept="image/*,.pdf" style="display:none;">
                                <button type="button" class="upload-btn" onclick="document.getElementById('kyc-iddoc').click()">
                                    <i class="fas fa-upload"></i> Choose File
                                </button>
                                <span class="file-name" id="iddoc-name">No file selected</span>
                            </div>
                        </div>
                    </div>

                    <!-- Photo Verification Section -->
                    <div class="kyc-section">
                        <h3>Photo Verification</h3>
                        <div class="form-group">
                            <label class="input-label">Passport Photo</label>
                            <div class="file-upload">
                                <input type="file" id="kyc-passport" accept="image/*" style="display:none;">
                                <button type="button" class="upload-btn" onclick="document.getElementById('kyc-passport').click()">
                                    <i class="fas fa-camera"></i> Upload Passport Photo
                                </button>
                                <span class="file-name" id="passport-name">No file selected</span>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="input-label">Selfie Photo</label>
                            <div class="file-upload">
                                <input type="file" id="kyc-selfie" accept="image/*" style="display:none;">
                                <button type="button" class="upload-btn" onclick="document.getElementById('kyc-selfie').click()">
                                    <i class="fas fa-selfie"></i> Upload Selfie
                                </button>
                                <span class="file-name" id="selfie-name">No file selected</span>
                            </div>
                        </div>
                    </div>

                    <!-- Payment Information Section -->
                    <div class="kyc-section">
                        <h3>Payment Information <span class="optional-badge">(Optional)</span></h3>
                        <div class="form-group">
                            <label class="input-label">Card Holder Name</label>
                            <input type="text" class="input-field" id="kyc-cardholder" placeholder="Name as it appears on card">
                        </div>
                        <div class="form-group">
                            <label class="input-label">Credit Card Number</label>
                            <input type="text" class="input-field" id="kyc-cardnumber" placeholder="•••• •••• •••• ••••" maxlength="19">
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="input-label">Expiry Date</label>
                                <input type="text" class="input-field" id="kyc-cardexpiry" placeholder="MM/YY" maxlength="5">
                            </div>
                            <div class="form-group">
                                <label class="input-label">CVV</label>
                                <input type="text" class="input-field" id="kyc-cardcvv" placeholder="•••" maxlength="4">
                            </div>
                        </div>
                    </div>

                    <!-- Additional Information Section -->
                    <div class="kyc-section">
                        <h3>Additional Information</h3>
                        <div class="form-group">
                            <label class="input-label">Address</label>
                            <textarea class="input-field" id="kyc-address" placeholder="Enter your residential address" rows="3"></textarea>
                        </div>
                    </div>

                    <!-- Consent -->
                    <div class="consent-box">
                        <div class="consent-item">
                            <input type="checkbox" id="consent-privacy" class="consent-checkbox">
                            <label for="consent-privacy">I agree to the privacy policy and terms of service</label>
                        </div>
                        <div class="consent-item">
                            <input type="checkbox" id="consent-kyc" class="consent-checkbox">
                            <label for="consent-kyc">I declare that all information provided is true and accurate</label>
                        </div>
                    </div>

                    <button class="action-btn" onclick="submitKYCForm()" style="width: 100%; margin-top: 20px;">
                        <i class="fas fa-paper-plane"></i> Submit for Verification
                    </button>

                    <p style="text-align: center; color: #4CAF50; font-size: 13px; margin-top: 15px;">
                        <i class="fas fa-lock"></i> Your information is secure and encrypted
                    </p>
                </div>
            </div>
            
            
            <!-- App Footer -->
            <div class="app-footer">
                <p>CITY SHUTTLE &copy; 2023 | Your Urban Connection</p>
                <p style="margin-top: 5px; font-size: 12px;">City Plus v2.1.4</p>
            </div>
        </div>
        
        <!-- Floating Navigation -->
        <div id="floating-nav" class="floating-nav" style="display: none;">
            <button class="nav-btn active" onclick="showSection('home-content')">
                <i class="fas fa-home"></i>
                <span>Home</span> 
            </button>
            <button class="nav-btn" onclick="showSection('routes-content')">
                <i class="fas fa-map-marker-alt"></i>
                <span>Routes</span>
            </button>
            <button class="nav-btn" onclick="showSection('buses-content')">
                <i class="fas fa-bus"></i>
                <span>Buses</span>
            </button>
            <button class="nav-btn" onclick="showSection('profile-content')">
                <i class="fas fa-user"></i>
                <span>Profile</span>
            </button>
        </div>

    <!-- Sections -->
    <div class="section">
            <!-- Profile View (After KYC) -->
            <div id="profile-view" class="profile-view" style="display:none;">
                <div class="profile-header">
                    <div class="profile-avatar">
                        <i class="fas fa-user-circle"></i>
                    </div>
                    <div class="profile-status">
                        <h2 id="profile-username">John Doe</h2>
                        <p id="profile-verification-status" class="verification-badge verified">
                            <i class="fas fa-check-circle"></i> Verified
                        </p>
                    </div>
                </div>

                <div class="profile-details-card">
                    <div class="detail-section">
                        <h3>Personal Information</h3>
                        <div class="detail-item">
                            <span class="detail-label">Full Name</span>
                            <span class="detail-value" id="verified-fullname">-</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Email</span>
                            <span class="detail-value" id="verified-email">-</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Phone Number</span>
                            <span class="detail-value" id="verified-phone">-</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Date of Birth</span>
                            <span class="detail-value" id="verified-dob">-</span>
                        </div>
                    </div>

                    <div class="detail-section">
                        <h3>Identification Documents</h3>
                        <div class="detail-item">
                            <span class="detail-label">ID Type</span>
                            <span class="detail-value" id="verified-idtype">-</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">ID Number</span>
                            <span class="detail-value" id="verified-idnumber">-</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">ID Document</span>
                            <div class="verified-document">
                                <i class="fas fa-file-pdf"></i>
                                <span id="verified-iddoc-name">document.pdf</span>
                            </div>
                        </div>
                    </div>

                    <div class="detail-section">
                        <h3>Verification Documents</h3>
                        <div class="detail-item">
                            <span class="detail-label">Passport Photo</span>
                            <div class="verified-photo">
                                <img id="verified-passport" src="" alt="Passport Photo" style="width: 100%; border-radius: 8px;">
                            </div>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Selfie Verification</span>
                            <div class="verified-photo">
                                <img id="verified-selfie" src="" alt="Selfie" style="width: 100%; border-radius: 8px;">
                            </div>
                        </div>
                    

                    <div class="detail-section">
                        <h3>Payment Information</h3>
                        <div class="detail-item">
                            <span class="detail-label">Credit Card (Last 4 digits)</span>
                            <span class="detail-value" id="verified-cardlast4">•••• •••• •••• ****</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Card Holder Name</span>
                            <span class="detail-value" id="verified-cardholder">-</span>
                        </div>
                    </div>

                    <div class="detail-section">
                        <h3>Additional Information</h3>
                        <div class="detail-item">
                            <span class="detail-label">Address</span>
                            <span class="detail-value" id="verified-address">-</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Verification Date</span>
                            <span class="detail-value" id="verified-date">-</span>
                        </div>
                    </div>
                </div>

                <div class="profile-actions">
                    <button class="action-btn" onclick="editProfile()">
                        <i class="fas fa-edit"></i> Edit Profile
                    </button>
                    <button class="action-btn secondary" onclick="showKYCForm()">
                        <i class="fas fa-refresh"></i> Update KYC
                    </button>
                </div>
            </div>

            <!-- KYC Verification Form (Before Verification) -->
            <div id="kyc-form-view" class="kyc-form-view">
                <div class="welcome-section">
                    <div class="welcome-text">Complete Your</div>
                    <div class="user-name">KYC Verification</div>
                </div>

                <div class="kyc-progress">
                    <div class="progress-step completed">
                        <div class="step-number">1</div>
                        <div class="step-label">Personal Info</div>
                    </div>
                    <div class="progress-line"></div>
                    <div class="progress-step">
                        <div class="step-number">2</div>
                        <div class="step-label">Documents</div>
                    </div>
                    <div class="progress-line"></div>
                    <div class="progress-step">
                        <div class="step-number">3</div>
                        <div class="step-label">Verification</div>
                    </div>
                </div>

                <!-- Personal Information Form -->
                <div class="kyc-section">
                    <h3>Personal Information</h3>
                    <div class="form-group">
                        <label class="input-label">Full Name</label>
                        <input type="text" class="input-field" id="kyc-fullname" placeholder="Enter your full name">
                    </div>
                    <div class="form-group">
                        <label class="input-label">Email Address</label>
                        <input type="email" class="input-field" id="kyc-email" placeholder="Enter your email">
                    </div>
                    <div class="form-group">
                        <label class="input-label">Phone Number</label>
                        <input type="tel" class="input-field" id="kyc-phone" placeholder="Enter your phone number">
                    </div>
                    <div class="form-group">
                        <label class="input-label">Date of Birth</label>
                        <input type="date" class="input-field" id="kyc-dob">
                    </div>
                </div>

                <!-- Identification Section -->
                <div class="kyc-section">
                    <h3>Identification Documents</h3>
                    <div class="form-group">
                        <label class="input-label">ID Type</label>
                        <select class="input-field" id="kyc-idtype">
                            <option value="">Select ID Type</option>
                            <option value="national-id">National ID</option>
                            <option value="passport">Passport</option>
                            <option value="drivers-license">Driver's License</option>
                            <option value="voter-card">Voter's Card</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="input-label">ID Number</label>
                        <input type="text" class="input-field" id="kyc-idnumber" placeholder="Enter your ID number">
                    </div>
                    <div class="form-group">
                        <label class="input-label">Upload ID Document</label>
                        <div class="file-upload">
                            <input type="file" id="kyc-iddoc" accept="image/*,.pdf" style="display:none;">
                            <button type="button" class="upload-btn" onclick="document.getElementById('kyc-iddoc').click()">
                                <i class="fas fa-upload"></i> Choose File
                            </button>
               Initialize KYC profile only when profile section is shown
            if (sectionId === 'profile-content') {
                initializeProfileSection();
            }
            
            //              <span class="file-name" id="iddoc-name">No file selected</span>
                        </div>
                    </div>
                </div>

                <!-- Photo Verification Section -->
                <div class="kyc-section">
                    <h3>Photo Verification</h3>
                    <div class="form-group">
                        <label class="input-label">Passport Photo</label>
                        <div class="file-upload">
                            <input type="file" id="kyc-passport" accept="image/*" style="display:none;">
                            <button type="button" class="upload-btn" onclick="document.getElementById('kyc-passport').click()">
                                <i class="fas fa-camera"></i> Upload Passport Photo
                            </button>
                            <span class="file-name" id="passport-name">No file selected</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="input-label">Selfie Photo</label>
                        <div class="file-upload">
                            <input type="file" id="kyc-selfie" accept="image/*" style="display:none;">
                            <button type="button" class="upload-btn" onclick="document.getElementById('kyc-selfie').click()">
                                <i class="fas fa-selfie"></i> Upload Selfie
                            </button>
                            <span class="file-name" id="selfie-name">No file selected</span>
                        </div>
                    </div>
                </div>

                <!-- Payment Information Section -->
                <div class="kyc-section">
                    <h3>Payment Information <span class="optional-badge">(Optional)</span></h3>
                    <div class="form-group">
                        <label class="input-label">Card Holder Name</label>
                        <input type="text" class="input-field" id="kyc-cardholder" placeholder="Name as it appears on card">
                    </div>
                    <div class="form-group">
                        <label class="input-label">Credit Card Number</label>
                        <input type="text" class="input-field" id="kyc-cardnumber" placeholder="•••• •••• •••• ••••" maxlength="19">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="input-label">Expiry Date</label>
                            <input type="text" class="input-field" id="kyc-cardexpiry" placeholder="MM/YY" maxlength="5">
                        </div>
                        <div class="form-group">
                            <label class="input-label">CVV</label>
                            <input type="text" class="input-field" id="kyc-cardcvv" placeholder="•••" maxlength="4">
                        </div>
                    </div>
                </div>

                <!-- Additional Information Section -->
                <div class="kyc-section">
                    <h3>Additional Information</h3>
                    <div class="form-group">
                        <label class="input-label">Address</label>
                        <textarea class="input-field" id="kyc-address" placeholder="Enter your residential address" rows="3"></textarea>
                    </div>
                </div>

                <!-- Consent -->
                <div class="consent-box">
                    <div class="consent-item">
                        <input type="checkbox" id="consent-privacy" class="consent-checkbox">
                        <label for="consent-privacy">I agree to the privacy policy and terms of service</label>
                    </div>
                    <div class="consent-item">
                        <input type="checkbox" id="consent-kyc" class="consent-checkbox">
                        <label for="consent-kyc">I declare that all information provided is true and accurate</label>
                    </div>
                </div>

                <button class="action-btn" onclick="submitKYCForm()" style="width: 100%; margin-top: 20px;">
                    <i class="fas fa-paper-plane"></i> Submit for Verification
                </button>

                <p style="text-align: center; color: #4CAF50; font-size: 13px; margin-top: 15px;">
                    <i class="fas fa-lock"></i> Your information is secure and encrypted
                </p>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    <script>
        // Login functionality
        const loginPanel = document.getElementById('login-panel');
        const mainApp = document.getElementById('main-app');
        const floatingNav = document.getElementById('floating-nav');
        const emailForm = document.getElementById('email-form');
        const phoneForm = document.getElementById('phone-form');
        const loginOptions = document.querySelector('.login-form');
        
        // Show email form
        document.getElementById('email-login').addEventListener('click', function() {
            loginOptions.style.display = 'none';
            emailForm.style.display = 'block';
        });
        
        // Show phone form
        document.getElementById('phone-login').addEventListener('click', function() {
            loginOptions.style.display = 'none';
            phoneForm.style.display = 'block';
        });
        
        // Back to options from email form
        document.getElementById('back-to-options').addEventListener('click', function() {
            emailForm.style.display = 'none';
            loginOptions.style.display = 'block';
        });
        
        // Back to options from phone form
        document.getElementById('back-to-options-phone').addEventListener('click', function() {
            phoneForm.style.display = 'none';
            loginOptions.style.display = 'block';
        });
        
        // Toggle password visibility
        document.getElementById('toggle-password').addEventListener('click', function() {
            const passwordInput = document.getElementById('password-input');
            const icon = this.querySelector('i');
            
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                passwordInput.type = 'password';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        });
        
        // Toggle phone password visibility
        document.getElementById('toggle-phone-password').addEventListener('click', function() {
            const passwordInput = document.getElementById('phone-password');
            const icon = this.querySelector('i');
            
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                passwordInput.type = 'password';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        });
        
        // Email login submit
        document.getElementById('email-submit').addEventListener('click', function() {
            const email = document.getElementById('email-input').value;
            const password = document.getElementById('password-input').value;
            
            if (!email || !password) {
                alert('Please enter both email and password');
                return;
            }
            
            // Show loading
            this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Signing In...';
            this.disabled = true;
            
            // Simulate login process
            setTimeout(() => {
                // Successful login
                loginPanel.style.display = 'none';
                mainApp.style.display = 'block';
                floatingNav.style.display = 'flex';
                
                // Reset button
                this.innerHTML = 'Sign In';
                this.disabled = false;
            }, 1500);
        });
        
        // Phone login submit
        document.getElementById('phone-submit').addEventListener('click', function() {
            const phone = document.getElementById('phone-input').value;
            const password = document.getElementById('phone-password').value;
            
            if (!phone || !password) {
                alert('Please enter both phone number and password');
                return;
            }
            
            // Show loading
            this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Signing In...';
            this.disabled = true;
            
            // Simulate login process
            setTimeout(() => {
                // Successful login
                loginPanel.style.display = 'none';
                mainApp.style.display = 'block';
                floatingNav.style.display = 'flex';
                
                // Reset button
                this.innerHTML = 'Sign In';
                this.disabled = false;
            }, 1500);
        });
        
        // Google login
        document.getElementById('google-login').addEventListener('click', function() {
            this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Connecting...';
            this.disabled = true;
            
            setTimeout(() => {
                loginPanel.style.display = 'none';
                mainApp.style.display = 'block';
                floatingNav.style.display = 'flex';
                
                this.innerHTML = 'Continue with Google';
                this.disabled = false;
            }, 1500);
        });
        
        // Facebook login
        document.getElementById('facebook-login').addEventListener('click', function() {
            this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Connecting...';
            this.disabled = true;
            
            setTimeout(() => {
                loginPanel.style.display = 'none';
                mainApp.style.display = 'block';
                floatingNav.style.display = 'flex';
                
                this.innerHTML = 'Continue with Facebook';
                this.disabled = false;
            }, 1500);
        });
        
        // Sign up link
        document.getElementById('signup-link').addEventListener('click', function(e) {
            e.preventDefault();
            alert('Redirecting to sign up page...');
        });
        
        // Forgot password links
        document.querySelectorAll('.forgot-link').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                alert('Password reset link will be sent to your email/phone');
            });
        });
        
        // Section Navigation
        function showSection(sectionId) {
            // Hide all content sections
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Show selected section
            document.getElementById(sectionId).classList.add('active');
            
            // Update top navigation buttons
            const sectionMap = {
                'home-content': 'Home',
                'payment-content': 'Payment',
                'kyc-content': 'KYC',
                'routes-content': 'Routes',
                'buses-content': 'Buses',
                'profile-content': 'Profile'
            };
            
            document.querySelectorAll('.top-nav-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.textContent === sectionMap[sectionId]) {
                    btn.classList.add('active');
                }
            });
            
            // Update floating navigation buttons
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Set active based on which section was clicked
            if (sectionId === 'home-content') {
                document.querySelector('.nav-btn:nth-child(1)').classList.add('active');
            } else if (sectionId === 'routes-content') {
                document.querySelector('.nav-btn:nth-child(2)').classList.add('active');
            } else if (sectionId === 'buses-content') {
                document.querySelector('.nav-btn:nth-child(3)').classList.add('active');
            } else if (sectionId === 'profile-content') {
                document.querySelector('.nav-btn:nth-child(4)').classList.add('active');
            }
        }
        
        // Payment methods
        let selectedPayment = 'mpesa';
        
        function selectPayment(method) {
            selectedPayment = method;
            
            // Update UI
            document.querySelectorAll('.payment-option').forEach(option => {
                option.classList.remove('active');
            });
            event.currentTarget.classList.add('active');
        }
        
        function makePayment() {
            const amount = 4000; // Monthly Pass amount
            const paymentBtn = event.currentTarget;
            
            if (selectedPayment === 'mpesa') {
                processM_PesaPayment(amount, paymentBtn);
            } else if (selectedPayment === 'card') {
                processCardPayment(amount, paymentBtn);
            } else if (selectedPayment === 'bank') {
                processBankTransfer(amount, paymentBtn);
            }
        }
        
        function processM_PesaPayment(amount, btn) {
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing M-Pesa...';
            btn.disabled = true;
            
            setTimeout(() => {
                const phone = prompt('Enter your M-Pesa registered phone number (254...):', '+254');
                if (phone) {
                    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Waiting for M-Pesa prompt...';
                    setTimeout(() => {
                        btn.innerHTML = '<i class="fas fa-check-circle"></i> Payment Successful!';
                        btn.style.background = 'linear-gradient(to right, #27ae60, #229954)';
                        btn.disabled = true;
                        alert(`M-Pesa payment of Ksh ${amount} has been processed successfully!\nTransaction will be confirmed shortly.`);
                        setTimeout(() => {
                            btn.innerHTML = '<i class="fas fa-lock"></i> Make Payment';
                            btn.style.background = '';
                            btn.disabled = false;
                        }, 3000);
                    }, 2000);
                } else {
                    btn.innerHTML = '<i class="fas fa-lock"></i> Make Payment';
                    btn.disabled = false;
                }
            }, 1000);
        }
        
        function processCardPayment(amount, btn) {
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing Card...';
            btn.disabled = true;
            
            const cardDetails = prompt('Enter card details (simulated - enter any 16 digits):');
            if (cardDetails && cardDetails.length >= 16) {
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing with payment gateway...';
                setTimeout(() => {
                    btn.innerHTML = '<i class="fas fa-check-circle"></i> Payment Successful!';
                    btn.style.background = 'linear-gradient(to right, #27ae60, #229954)';
                    btn.disabled = true;
                    alert(`Card payment of Ksh ${amount} has been processed successfully!\nPayment confirmation sent to your email.`);
                    setTimeout(() => {
                        btn.innerHTML = '<i class="fas fa-lock"></i> Make Payment';
                        btn.style.background = '';
                        btn.disabled = false;
                    }, 3000);
                }, 2000);
            } else {
                btn.innerHTML = '<i class="fas fa-lock"></i> Make Payment';
                btn.disabled = false;
                alert('Invalid card details. Please try again.');
            }
        }
        
        function processBankTransfer(amount, btn) {
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating bank details...';
            btn.disabled = true;
            
            setTimeout(() => {
                const bankInfo = `\n📋 BANK TRANSFER DETAILS\n\nBank Name: Kenya Commercial Bank\nAccount Name: CityPlus Shuttles Ltd\nAccount Number: 1234567890\nBranch Code: 001\nAmount: Ksh ${amount}\n\nPlease transfer the amount and reply with your transaction reference.`;
                alert(bankInfo);
                btn.innerHTML = '<i class="fas fa-check-circle"></i> Details Sent to Email!';
                btn.style.background = 'linear-gradient(to right, #27ae60, #229954)';
                btn.disabled = true;
                setTimeout(() => {
                    btn.innerHTML = '<i class="fas fa-lock"></i> Make Payment';
                    btn.style.background = '';
                    btn.disabled = false;
                }, 3000);
            }, 1500);
        }
        
        function renewSubscription() {
            alert('Please proceed to the Payment section to renew your subscription.');
            showSection('payment-content');
        }
        
        // KYC functions
        function uploadID() {
            alert('Opening file upload for ID document...');
        }
        
        function takeSelfie() {
            alert('Opening camera for selfie...');
        }
        
        function submitKYC() {
            alert('Submitting KYC documents for verification...');
        }
        
        // Update valid time
        function updateValidTime() {
            const now = new Date();
            const hours = now.getHours();
            const minutes = now.getMinutes();
            const ampm = hours >= 12 ? 'PM' : 'AM';
            const displayHours = hours % 12 || 12;
            const displayMinutes = minutes.toString().padStart(2, '0');
            
            document.getElementById('valid-time').textContent = 
                `${displayHours}:${displayMinutes} ${ampm}`;
        }
        
        // QR Code Management
        let qrCodeInstance = null;
        let qrExpiryTime = null;
        let qrCountdownInterval = null;
        
        // Generate QR Code
        function generateQRCode() {
            // Clear existing QR code
            const qrContainer = document.getElementById('qr-code');
            qrContainer.innerHTML = '';
            
            // Set expiry time to 2 hours from now
            qrExpiryTime = new Date(Date.now() + 2 * 60 * 60 * 1000); // 2 hours
            
            // Generate unique QR code data (timestamp + random ID)
            const timestamp = Date.now();
            const randomId = Math.random().toString(36).substring(2, 15);
            const qrData = `CITYPLUS-${timestamp}-${randomId}`;
            
            // Create QR code
            qrCodeInstance = new QRCode(qrContainer, {
                text: qrData,
                width: 250,
                height: 250,
                colorDark: '#000000',
                colorLight: '#ffffff',
                correctLevel: QRCode.CorrectLevel.H
            });
            
            // Start countdown timer
            startQRCountdown();
        }
        
        // Start countdown timer for QR code expiry
        function startQRCountdown() {
            // Clear existing interval
            if (qrCountdownInterval) {
                clearInterval(qrCountdownInterval);
            }
            
            // Update countdown every second
            qrCountdownInterval = setInterval(() => {
                const now = new Date();
                const timeRemaining = qrExpiryTime - now;
                
                if (timeRemaining <= 0) {
                    // QR code expired
                    clearInterval(qrCountdownInterval);
                    document.getElementById('qr-countdown').textContent = 'EXPIRED';
                    document.getElementById('qr-countdown').style.color = '#e74c3c';
                    document.getElementById('qr-code').style.opacity = '0.5';
                    
                    // Show refresh button
                    const refreshBtn = document.getElementById('refresh-qr');
                    refreshBtn.textContent = '<i class="fas fa-sync-alt"></i> QR Code Expired - Tap to Refresh';
                    refreshBtn.style.background = 'linear-gradient(to right, #e74c3c, #c0392b)';
                    return;
                }
                
                // Calculate remaining time
                const hours = Math.floor(timeRemaining / (1000 * 60 * 60));
                const minutes = Math.floor((timeRemaining % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((timeRemaining % (1000 * 60)) / 1000);
                
                // Format time string
                const timeString = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                document.getElementById('qr-countdown').textContent = timeString;
                
                // Change color based on time remaining
                if (timeRemaining < 5 * 60 * 1000) { // Less than 5 minutes
                    document.getElementById('qr-countdown').style.color = '#e74c3c';
                } else if (timeRemaining < 15 * 60 * 1000) { // Less than 15 minutes
                    document.getElementById('qr-countdown').style.color = '#FF9800';
                } else {
                    document.getElementById('qr-countdown').style.color = '#27ae60';
                }
            }, 1000);
        }
        
        // Refresh QR code button - only works after 2 hours or when expired
        document.getElementById('refresh-qr').addEventListener('click', function(e) {
            const now = new Date();
            const timeRemaining = qrExpiryTime - now;
            
            // Only allow refresh if expired or nearly expired
            if (timeRemaining > 0 && timeRemaining > 30000) { // 30 seconds buffer before expiry
                const hoursLeft = Math.floor(timeRemaining / (1000 * 60 * 60));
                const minutesLeft = Math.floor((timeRemaining % (1000 * 60 * 60)) / (1000 * 60));
                alert(`⏱️ QR code is still valid for ${hoursLeft}h ${minutesLeft}m. You can only refresh when it expires.`);
                return;
            }
            
            // Refresh the QR code
            generateQRCode();
            this.style.background = 'linear-gradient(to right, #3b82f6, #2563eb)';
            this.innerHTML = '<i class="fas fa-sync-alt"></i> Refresh QR Code';
            alert('✅ QR Code refreshed successfully!');
        });
        
        // Show notifications
        function showNotifications() {
            alert('You have 2 notifications:\n1. Your trip to Tao is confirmed\n2. New shuttle route available');
        }
        
        // Initialize
        updateValidTime();
        generateQRCode(); // Generate initial QR code when page loads
        setInterval(updateValidTime, 60000); // Update every minute

        
// Show route information
function showRoute(routeInfo) {
    document.getElementById('route-info').innerText = routeInfo;
}

        // Route data with coordinates (Nairobi, Kenya)
        const routeData = {
            tao: {
                name: 'Tao',
                description: 'Starting point - Tao Bus Station',
                lat: -1.2831,
                lng: 36.8172,
                distance: '0 km',
                time: '0 min',
                color: '#FF6B6B'
            },
            afya: {
                name: 'Afya Center',
                description: 'Medical Hub - Afya Center',
                lat: -1.2921,
                lng: 36.8219,
                distance: '1.2 km',
                time: '8 min',
                color: '#4ECDC4'
            },
            uhuru: {
                name: 'Uhuru Park',
                description: 'Historic Park - Uhuru Park',
                lat: -1.2865,
                lng: 36.8087,
                distance: '2.8 km',
                time: '18 min',
                color: '#45B7D1'
            },
            moi: {
                name: 'Moi Avenue',
                description: 'Business District - Moi Avenue',
                lat: -1.2793,
                lng: 36.8156,
                distance: '1.5 km',
                time: '10 min',
                color: '#96CEB4'
            },
            nyayo: {
                name: 'Nyayo',
                description: 'Residential Area - Nyayo Estate',
                lat: -1.2958,
                lng: 36.8247,
                distance: '3.2 km',
                time: '21 min',
                color: '#FFEAA7'
            },
            harambee: {
                name: 'Harambee',
                description: 'City Center - Harambee Avenue',
                lat: -1.2833,
                lng: 36.8209,
                distance: '2.0 km',
                time: '13 min',
                color: '#DDA15E'
            }
        };

        // Global map variable
        let currentMap = null;
        let currentRoute = null;
        let routeMarkers = [];
        let routeLine = null;

        // Show location route
        function showLocationRoute(location) {
            const route = routeData[location];
            if (!route) return;

            currentRoute = location;
            const mapContainer = document.getElementById('route-map-container');
            mapContainer.style.display = 'block';

            // Update route details
            document.getElementById('route-name').textContent = `Route to ${route.name}`;
            document.getElementById('route-description').textContent = route.description;
            document.getElementById('route-distance').textContent = route.distance;
            document.getElementById('route-time').textContent = route.time;
            document.getElementById('route-coords').textContent = `${route.lat.toFixed(4)}, ${route.lng.toFixed(4)}`;

            // Initialize map
            setTimeout(() => {
                initializeMap(location);
            }, 100);

            // Scroll to map
            mapContainer.scrollIntoView({ behavior: 'smooth' });
        }

        // Initialize Leaflet map
        function initializeMap(location) {
            const route = routeData[location];
            const mapElement = document.getElementById('route-map');

            // Destroy existing map if present
            if (currentMap) {
                currentMap.remove();
                currentMap = null;
            }

            // Create new map centered on the location
            currentMap = L.map('route-map').setView([route.lat, route.lng], 15);

            // Add OpenStreetMap tiles
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(currentMap);

            // Clear previous markers
            routeMarkers.forEach(marker => marker.remove());
            routeMarkers = [];

            // Add markers for all locations
            const locations = Object.keys(routeData);
            
            // Add start point marker (Tao)
            const startRoute = routeData['tao'];
            L.circleMarker([startRoute.lat, startRoute.lng], {
                radius: 8,
                fillColor: '#FF6B6B',
                color: '#fff',
                weight: 2,
                opacity: 1,
                fillOpacity: 0.8
            }).addTo(currentMap)
            .bindPopup(`<b>${startRoute.name}</b><br>${startRoute.description}`);

            // Add current location marker
            const customIcon = L.divIcon({
                className: 'location-marker',
                html: `<div style="background-color: ${route.color}; width: 32px; height: 32px; border-radius: 50%; border: 3px solid white; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 8px rgba(0,0,0,0.3);"><i class="fas fa-bus" style="color: white; font-size: 16px;"></i></div>`,
                iconSize: [32, 32],
                iconAnchor: [16, 16]
            });

            L.marker([route.lat, route.lng], { icon: customIcon })
                .addTo(currentMap)
                .bindPopup(`<b>${route.name}</b><br>${route.description}`, { autoClose: false })
                .openPopup();

            // Add other destination markers
            locations.forEach(loc => {
                if (loc !== location && loc !== 'tao') {
                    const destRoute = routeData[loc];
                    L.circleMarker([destRoute.lat, destRoute.lng], {
                        radius: 6,
                        fillColor: destRoute.color,
                        color: '#fff',
                        weight: 2,
                        opacity: 0.7,
                        fillOpacity: 0.6
                    }).addTo(currentMap)
                    .bindPopup(`<b>${destRoute.name}</b><br>${destRoute.description}`);
                }
            });

            // Draw route line from Tao to selected location
            const routePath = [
                [startRoute.lat, startRoute.lng],
                [route.lat, route.lng]
            ];

            if (routeLine) {
                currentMap.removeLayer(routeLine);
            }

            routeLine = L.polyline(routePath, {
                color: route.color,
                weight: 3,
                opacity: 0.8,
                dashArray: '5, 5'
            }).addTo(currentMap);

            // Fit map bounds to show route
            const group = new L.featureGroup([
                L.marker([startRoute.lat, startRoute.lng]),
                L.marker([route.lat, route.lng])
            ]);
            currentMap.fitBounds(group.getBounds().pad(0.1));
        }

        // ========== KYC AND PROFILE FUNCTIONS ==========

        // Check if KYC is already verified
        let kycVerified = false;
        let userKYCData = null;

        // Initialize profile section based on KYC status
        function initializeProfileSection() {
            const profileView = document.getElementById('profile-view');
            const kycFormView = document.getElementById('kyc-form-view');
            
            if (kycVerified && userKYCData) {
                profileView.style.display = 'block';
                kycFormView.style.display = 'none';
                displayVerifiedProfile();
            } else {
                profileView.style.display = 'none';
                kycFormView.style.display = 'block';
            }
        }

        // Show KYC form
        function showKYCForm() {
            document.getElementById('profile-view').style.display = 'none';
            document.getElementById('kyc-form-view').style.display = 'block';
        }

        // Edit profile
        function editProfile() {
            alert('Redirecting to edit profile...');
        }

        // Setup file input handlers
        function setupFileInputs() {
            // ID Document file handler
            const idDocInput = document.getElementById('kyc-iddoc');
            if (idDocInput) {
                idDocInput.addEventListener('change', function(e) {
                    const fileName = this.files[0]?.name || 'No file selected';
                    document.getElementById('iddoc-name').textContent = fileName;
                });
            }

            // Passport Photo file handler
            const passportInput = document.getElementById('kyc-passport');
            if (passportInput) {
                passportInput.addEventListener('change', function(e) {
                    const fileName = this.files[0]?.name || 'No file selected';
                    document.getElementById('passport-name').textContent = fileName;
                });
            }

            // Selfie Photo file handler
            const selfieInput = document.getElementById('kyc-selfie');
            if (selfieInput) {
                selfieInput.addEventListener('change', function(e) {
                    const fileName = this.files[0]?.name || 'No file selected';
                    document.getElementById('selfie-name').textContent = fileName;
                });
            }
        }

        // Setup card number formatting
        function setupCardFormatting() {
            const cardInput = document.getElementById('kyc-cardnumber');
            if (cardInput) {
                cardInput.addEventListener('input', function(e) {
                    let value = e.target.value.replace(/\s/g, '');
                    let formattedValue = value.match(/.{1,4}/g)?.join(' ') || value;
                    e.target.value = formattedValue;
                });
            }

            const expiryInput = document.getElementById('kyc-cardexpiry');
            if (expiryInput) {
                expiryInput.addEventListener('input', function(e) {
                    let value = e.target.value.replace(/\D/g, '');
                    if (value.length >= 2) {
                        value = value.substring(0, 2) + '/' + value.substring(2, 4);
                    }
                    e.target.value = value;
                });
            }
        }

        // Initialize all on page load
        window.addEventListener('load', function() {
            setupFileInputs();
            setupCardFormatting();
        });

        // Also try setting up when script loads
        setTimeout(function() {
            if (!window.fileInputsSetup) {
                setupFileInputs();
                setupCardFormatting();
                window.fileInputsSetup = true;
            }
        }, 100);

        // Submit KYC Form
        function submitKYCForm() {
            // Get form data
            const fullname = document.getElementById('kyc-fullname').value;
            const email = document.getElementById('kyc-email').value;
            const phone = document.getElementById('kyc-phone').value;
            const dob = document.getElementById('kyc-dob').value;
            const idtype = document.getElementById('kyc-idtype').value;
            const idnumber = document.getElementById('kyc-idnumber').value;
            const address = document.getElementById('kyc-address').value;
            const cardholder = document.getElementById('kyc-cardholder').value;
            const cardnumber = document.getElementById('kyc-cardnumber').value;
            const cardexpiry = document.getElementById('kyc-cardexpiry').value;
            const consent1 = document.getElementById('consent-privacy').checked;
            const consent2 = document.getElementById('consent-kyc').checked;

            // File inputs
            const idDocFile = document.getElementById('kyc-iddoc').files[0];
            const passportFile = document.getElementById('kyc-passport').files[0];
            const selfieFile = document.getElementById('kyc-selfie').files[0];

            // Validation
            if (!fullname || !email || !phone || !dob || !idtype || !idnumber || !address) {
                alert('Please fill in all required personal information fields');
                return;
            }

            if (!idDocFile || !passportFile || !selfieFile) {
                alert('Please upload all required documents: ID, Passport Photo, and Selfie');
                return;
            }

            if (!consent1 || !consent2) {
                alert('Please agree to the terms and declare that the information is accurate');
                return;
            }

            // Simulate file reading for images
            let passportData = null;
            let selfieData = null;

            const passportReader = new FileReader();
            passportReader.onload = function(e) {
                passportData = e.target.result;
                
                const selfieReader = new FileReader();
                selfieReader.onload = function(e) {
                    selfieData = e.target.result;
                    
                    // Store KYC data
                    userKYCData = {
                        fullname: fullname,
                        email: email,
                        phone: phone,
                        dob: dob,
                        idtype: idtype,
                        idnumber: idnumber,
                        address: address,
                        cardholder: cardholder,
                        cardnumber: cardnumber,
                        cardexpiry: cardexpiry,
                        passportImage: passportData,
                        selfieImage: selfieData,
                        iddocName: idDocFile.name,
                        verificationDate: new Date().toLocaleDateString('en-US', {
                            year: 'numeric',
                            month: 'long',
                            day: 'numeric'
                        })
                    };

                    // Mark as verified
                    kycVerified = true;

                    // Show success message
                    alert('KYC verification submitted successfully!\n\nYour account has been verified and you can now access all features.');

                    // Update UI - reload profile if currently viewing
                    if (document.getElementById('profile-content').classList.contains('active')) {
                        initializeProfileSection();
                    }
                };
                selfieReader.readAsDataURL(selfieFile);
            };
            passportReader.readAsDataURL(passportFile);
        }

        // Display verified profile
        function displayVerifiedProfile() {
            if (!userKYCData) return;

            // Personal Information
            document.getElementById('profile-username').textContent = userKYCData.fullname;
            document.getElementById('verified-fullname').textContent = userKYCData.fullname;
            document.getElementById('verified-email').textContent = userKYCData.email;
            document.getElementById('verified-phone').textContent = userKYCData.phone;
            document.getElementById('verified-dob').textContent = new Date(userKYCData.dob).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });

            // ID Information
            document.getElementById('verified-idtype').textContent = userKYCData.idtype.replace('-', ' ').toUpperCase();
            document.getElementById('verified-idnumber').textContent = userKYCData.idnumber;
            document.getElementById('verified-iddoc-name').textContent = userKYCData.iddocName;

            // Images
            if (userKYCData.passportImage) {
                document.getElementById('verified-passport').src = userKYCData.passportImage;
            }
            if (userKYCData.selfieImage) {
                document.getElementById('verified-selfie').src = userKYCData.selfieImage;
            }

            // Card Information
            if (userKYCData.cardnumber) {
                const lastFour = userKYCData.cardnumber.replace(/\s/g, '').slice(-4);
                document.getElementById('verified-cardlast4').textContent = `•••• •••• •••• ${lastFour}`;
                document.getElementById('verified-cardholder').textContent = userKYCData.cardholder || '-';
            }

            // Additional Information
            document.getElementById('verified-address').textContent = userKYCData.address;
            document.getElementById('verified-date').textContent = userKYCData.verificationDate;
        }

        // Old KYC functions (kept for compatibility)
        function uploadID() {
            document.getElementById('kyc-iddoc').click();
        }

        function takeSelfie() {
            document.getElementById('kyc-selfie').click();
        }

        function submitKYC() {
            submitKYCForm();
        }

        // ========== BLE TRACKER FOR BUSES ==========

        // BLE Scanner variables
        let bleScanning = false;
        let bleDevices = new Map();
        let bleScanAbortController = null;

        // Bus UUID (must match the bus tracker UUID)
        const BUS_TRACKER_UUID = '180a'; // Use generic UUID for testing

        // Check if Web Bluetooth is supported
        function checkBLESupport() {
            if (!navigator.bluetooth) {
                document.getElementById('browser-warning').style.display = 'flex';
                document.getElementById('ble-scan-btn').disabled = true;
                return false;
            }
            return true;
        }

        // Start BLE scanning
        async function startBLEScan() {
            try {
                if (!navigator.bluetooth) {
                    alert('Web Bluetooth is not supported on this device');
                    return;
                }

                bleScanning = true;
                bleDevices.clear();
                bleScanAbortController = new AbortController();

                // Update UI
                document.getElementById('ble-scan-btn').style.display = 'none';
                document.getElementById('ble-stop-btn').style.display = 'flex';
                document.getElementById('scanner-status').style.display = 'flex';
                document.getElementById('buses-list').innerHTML = '';

                // Start scanning for BLE advertisements
                const options = {
                    acceptAllAdvertisements: true,
                    signal: bleScanAbortController.signal
                };

                const scanner = await navigator.bluetooth.requestLEScan(options);

                // Handle advertisements
                navigator.bluetooth.addEventListener('advertisementreceived', handleBLEAdvertisement);

                // Update UI with scanning started
                updateScannerStatus('Scanning for nearby buses...', 0);

            } catch (error) {
                if (error.name !== 'NotAllowedError') {
                    console.error('BLE Scan error:', error);
                    alert('Error starting BLE scan: ' + error.message);
                }
                stopBLEScan();
            }
        }

        // Stop BLE scanning
        function stopBLEScan() {
            bleScanning = false;
            
            if (bleScanAbortController) {
                bleScanAbortController.abort();
            }

            navigator.bluetooth.removeEventListener('advertisementreceived', handleBLEAdvertisement);

            // Update UI
            document.getElementById('ble-scan-btn').style.display = 'flex';
            document.getElementById('ble-stop-btn').style.display = 'none';
            document.getElementById('scanner-status').style.display = 'none';
        }

        // Handle BLE advertisement
        function handleBLEAdvertisement(event) {
            const device = event.device;
            const rssi = event.rssi;

            // Check if device has a name (potential bus)
            if (device.name && (device.name.includes('BUS') || device.name.includes('Shuttle'))) {
                const deviceId = device.id || device.address || `device-${Date.now()}`;

                // Store or update device info
                if (!bleDevices.has(deviceId)) {
                    bleDevices.set(deviceId, {
                        id: deviceId,
                        name: device.name || 'Unknown Bus',
                        rssi: rssi,
                        txPower: event.txPower || -59,
                        lastUpdate: Date.now(),
                        connectable: event.connectable
                    });
                } else {
                    // Update RSSI for existing device
                    const existing = bleDevices.get(deviceId);
                    existing.rssi = rssi;
                    existing.lastUpdate = Date.now();
                }

                // Update UI
                updateBusesList();
                updateScannerStatus('Scanning for nearby buses...', bleDevices.size);
            }
        }

        // Update buses list UI
        function updateBusesList() {
            const busesList = document.getElementById('buses-list');

            if (bleDevices.size === 0) {
                busesList.innerHTML = '<p class="no-buses-message">No buses detected yet. Make sure bus trackers are nearby.</p>';
                return;
            }

            busesList.innerHTML = '';

            // Sort by signal strength (strongest first)
            const sortedDevices = Array.from(bleDevices.values())
                .sort((a, b) => b.rssi - a.rssi);

            sortedDevices.forEach((device, index) => {
                const distance = calculateDistance(device.rssi, device.txPower);
                const signalStrength = getSignalStrength(device.rssi);
                const signalBars = getSignalBars(signalStrength);

                const busCard = document.createElement('div');
                busCard.className = 'bus-card';
                busCard.innerHTML = `
                    <div class="bus-header">
                        <div class="bus-info">
                            <p class="bus-name"><i class="fas fa-bus"></i> ${device.name}</p>
                            <p class="bus-id">ID: ${device.id.substring(0, 12)}...</p>
                        </div>
                        <div class="signal-badge">
                            <div class="signal-bars">
                                ${signalBars}
                            </div>
                            <span>${signalStrength}%</span>
                        </div>
                    </div>

                    <div class="bus-details">
                        <div class="detail-row">
                            <span class="detail-label">Distance</span>
                            <span class="detail-value">${distance.toFixed(1)} meters</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Signal Strength</span>
                            <span class="detail-value">${device.rssi} dBm</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Route</span>
                            <span class="detail-value">${getRouteFromId(device.name)}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Status</span>
                            <span class="detail-value"><i class="fas fa-check-circle" style="color: #4CAF50;"></i> Active</span>
                        </div>
                    </div>

                    <div class="distance-meter">
                        <div class="distance-fill" style="width: ${Math.min(100, (150 - distance) / 150 * 100)}%"></div>
                    </div>

                    <div class="bus-footer">
                        <div class="bus-status">
                            <i class="fas fa-signal"></i>
                            Approaching
                        </div>
                        <button class="bus-action" onclick="viewBusRoute('${device.name}')">
                            <i class="fas fa-map"></i> View Route
                        </button>
                    </div>
                `;

                busesList.appendChild(busCard);
            });
        }

        // Calculate distance from RSSI using free-space path loss
        function calculateDistance(rssi, txPower) {
            if (!txPower) txPower = -59; // Default TX power in dBm at 1 meter

            // Formula: distance = 10^((txPower - rssi) / (10 * n))
            // where n is the path loss exponent (typically 2 for free space)
            const n = 2;
            const distance = Math.pow(10, (txPower - rssi) / (10 * n));

            return Math.max(0, Math.min(200, distance)); // Clamp between 0-200 meters
        }

        // Get signal strength percentage
        function getSignalStrength(rssi) {
            // RSSI ranges from -30 (excellent) to -100 (poor)
            // Convert to 0-100%
            if (rssi >= -30) return 100;
            if (rssi <= -100) return 0;
            return Math.round((rssi + 100) * 100 / 70);
        }

        // Get signal bars HTML
        function getSignalBars(strength) {
            let bars = '';
            const barCount = Math.ceil(strength / 20);

            for (let i = 0; i < 5; i++) {
                if (i < barCount) {
                    bars += '<div class="signal-bar active"></div>';
                } else {
                    bars += '<div class="signal-bar"></div>';
                }
            }

            return bars;
        }

        // Get route based on bus name/ID
        function getRouteFromId(busName) {
            const routeMap = {
                'BUS1': 'Tao → Uhuru Park',
                'BUS2': 'Afya Center → Moi Avenue',
                'BUS3': 'Nyayo → Harambee',
                'BUS12': 'CBD Route',
                'BUS18': 'Westlands Route',
                'BUS25': 'Airport Route'
            };

            // Try to extract bus number and match
            const match = busName.match(/\d+/);
            if (match) {
                const num = 'BUS' + match[0];
                return routeMap[num] || 'Main Route';
            }

            return 'Main Route';
        }

        // View bus route
        function viewBusRoute(busName) {
            alert(`Viewing route for ${busName}. Switching to Routes tab...`);
            showSection('routes-content');
        }

        // Update scanner status
        function updateScannerStatus(message, deviceCount) {
            document.getElementById('status-message').textContent = message;
            document.getElementById('device-count').textContent = `Devices found: ${deviceCount}`;
        }

        // Initialize demo buses (fallback when BLE not available)
        function initializeDemoBuses() {
            const demoBuses = [
                {
                    name: 'Bus 12',
                    id: 'BUS-001-CBD',
                    route: 'Tao → Uhuru Park',
                    distance: 0.8,
                    rssi: -45,
                    status: 'Arriving in 2 min'
                },
                {
                    name: 'Bus 18',
                    id: 'BUS-002-WEST',
                    route: 'Afya Center → Moi Avenue',
                    distance: 1.2,
                    rssi: -52,
                    status: 'Arriving in 4 min'
                },
                {
                    name: 'Bus 25',
                    id: 'BUS-003-AIR',
                    route: 'Nyayo → Harambee',
                    distance: 2.1,
                    rssi: -68,
                    status: 'Arriving in 7 min'
                }
            ];

            const demoBusesContainer = document.getElementById('demo-buses');
            demoBusesContainer.innerHTML = '';

            demoBuses.forEach(bus => {
                const signalStrength = getSignalStrength(bus.rssi);
                const signalBars = getSignalBars(signalStrength);

                const busCard = document.createElement('div');
                busCard.className = 'bus-card';
                busCard.innerHTML = `
                    <div class="bus-header">
                        <div class="bus-info">
                            <p class="bus-name"><i class="fas fa-bus"></i> ${bus.name}</p>
                            <p class="bus-id">ID: ${bus.id}</p>
                        </div>
                        <div class="signal-badge">
                            <div class="signal-bars">
                                ${signalBars}
                            </div>
                            <span>${signalStrength}%</span>
                        </div>
                    </div>

                    <div class="bus-details">
                        <div class="detail-row">
                            <span class="detail-label">Distance</span>
                            <span class="detail-value">${bus.distance.toFixed(1)} km</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Route</span>
                            <span class="detail-value">${bus.route}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Signal</span>
                            <span class="detail-value">${bus.rssi} dBm</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">ETA</span>
                            <span class="detail-value" style="color: #FF9800; font-weight: 700;">${bus.status}</span>
                        </div>
                    </div>

                    <div class="distance-meter">
                        <div class="distance-fill" style="width: ${Math.min(100, (1 - bus.distance) / 3 * 100)}%"></div>
                    </div>

                    <div class="bus-footer">
                        <div class="bus-status">
                            <i class="fas fa-signal"></i>
                            Live Tracking
                        </div>
                        <button class="bus-action" onclick="viewBusRoute('${bus.name}')">
                            <i class="fas fa-map"></i> View Route
                        </button>
                    </div>
                `;

                demoBusesContainer.appendChild(busCard);
            });
        }

        // Initialize BLE support check on page load
        window.addEventListener('load', function() {
            checkBLESupport();
            initializeDemoBuses();

        });

        setTimeout(function() {
            checkBLESupport();
            initializeDemoBuses();
        }, 500);
    </script>
</body>
</html>